# PR Review Golden Tasks
# EPIC 003: Evaluation Harness + Golden Tasks Framework
#
# Tests for automated PR review quality

tasks:
  - id: pr-review-simple
    name: Simple PR Review
    description: Review a simple single-file change
    workflow: pr-review
    rubric: pr-review.yaml
    input:
      type: pr-diff
      content: |
        diff --git a/src/utils.ts b/src/utils.ts
        index abc1234..def5678 100644
        --- a/src/utils.ts
        +++ b/src/utils.ts
        @@ -10,6 +10,10 @@ export function formatDate(date: Date): string {
           return date.toISOString();
         }

        +export function formatCurrency(amount: number): string {
        +  return `$${amount.toFixed(2)}`;
        +}
        +
         export function capitalize(str: string): string {
           return str.charAt(0).toUpperCase() + str.slice(1);
         }
      metadata:
        prNumber: 42
        author: testuser
    expectedOutput:
      minScore: 70
      requiredSections:
        - Summary
        - Changes
      requiredKeywords:
        - formatCurrency
        - utils
      goldenOutput: |
        ## Summary

        Adds a new `formatCurrency` utility function to `src/utils.ts`.

        ## Changes

        - **src/utils.ts** (line 13-15): New `formatCurrency(amount: number)` function that formats a number as a US dollar string using `toFixed(2)`.

        ## Recommendations

        - Consider adding locale support for international currency formatting (line 14).
        - Add unit tests covering edge cases (negative values, zero, large numbers).
    tags:
      - smoke
      - pr-review

  - id: pr-review-security
    name: Security-Sensitive PR Review
    description: Review a PR with potential security concerns
    workflow: pr-review
    rubric: pr-review.yaml
    input:
      type: pr-diff
      content: |
        diff --git a/src/auth.ts b/src/auth.ts
        index abc1234..def5678 100644
        --- a/src/auth.ts
        +++ b/src/auth.ts
        @@ -15,7 +15,8 @@ export async function validateToken(token: string): Promise<boolean> {
        -  const secret = process.env.JWT_SECRET;
        +  // TODO: Move to secure vault
        +  const secret = "hardcoded-secret-key";
           return jwt.verify(token, secret);
         }
      metadata:
        prNumber: 43
        author: testuser
    expectedOutput:
      minScore: 70
      requiredSections:
        - Summary
        - Security
      requiredKeywords:
        - security
        - hardcoded
        - secret
      forbiddenPatterns:
        - "looks good"
        - "lgtm"
      goldenOutput: |
        ## Summary

        Modifies JWT token validation in `src/auth.ts` to use a hardcoded secret instead of an environment variable.

        ## Security

        **Critical**: This PR introduces a hardcoded secret key on line 16, replacing the secure `process.env.JWT_SECRET` pattern. Hardcoded secrets are a severe security risk:

        - The secret value is exposed in source control history.
        - Rotating the key requires a code change and redeploy.
        - Anyone with repository access can extract the JWT signing key.

        ## Changes

        - **src/auth.ts** (line 15-16): Replaced `process.env.JWT_SECRET` with a hardcoded string literal `"hardcoded-secret-key"`.

        ## Recommendations

        - Revert to using `process.env.JWT_SECRET` or migrate to a secrets manager (e.g., Vault, AWS Secrets Manager).
        - Remove the hardcoded value from git history using `git filter-branch` or BFG Repo-Cleaner.
        - Add a pre-commit hook to detect hardcoded secrets.
    tags:
      - security
      - pr-review

  - id: pr-review-multifile
    name: Multi-File PR Review
    description: Review a PR with changes across multiple files
    workflow: pr-review
    rubric: pr-review.yaml
    input:
      type: pr-diff
      content: |
        diff --git a/src/api/routes.ts b/src/api/routes.ts
        index abc1234..def5678 100644
        --- a/src/api/routes.ts
        +++ b/src/api/routes.ts
        @@ -10,6 +10,7 @@ export const routes = [
           { path: '/users', handler: usersHandler },
           { path: '/posts', handler: postsHandler },
        +  { path: '/comments', handler: commentsHandler },
         ];
        diff --git a/src/api/handlers/comments.ts b/src/api/handlers/comments.ts
        new file mode 100644
        index 0000000..abc1234
        --- /dev/null
        +++ b/src/api/handlers/comments.ts
        @@ -0,0 +1,25 @@
        +import { Handler } from '../types';
        +
        +export const commentsHandler: Handler = async (req, res) => {
        +  const { postId } = req.params;
        +  const comments = await db.comments.findByPost(postId);
        +  return res.json(comments);
        +};
        diff --git a/test/comments.test.ts b/test/comments.test.ts
        new file mode 100644
        index 0000000..def5678
        --- /dev/null
        +++ b/test/comments.test.ts
        @@ -0,0 +1,15 @@
        +import { commentsHandler } from '../src/api/handlers/comments';
        +
        +describe('commentsHandler', () => {
        +  it('returns comments for a post', async () => {
        +    // test implementation
        +  });
        +});
      metadata:
        prNumber: 44
        author: testuser
    expectedOutput:
      minScore: 70
      requiredSections:
        - Summary
        - Changes
      requiredKeywords:
        - comments
        - handler
        - test
      goldenOutput: |
        ## Summary

        Adds a new `/comments` API endpoint with handler and test coverage.

        ## Changes

        - **src/api/routes.ts** (line 12): Registers new `/comments` route pointing to `commentsHandler`.
        - **src/api/handlers/comments.ts** (new file): Implements `commentsHandler` that fetches comments by `postId` from the database.
        - **test/comments.test.ts** (new file): Adds unit test for the comments handler.

        ## Recommendations

        - Add input validation for `postId` parameter to prevent injection attacks (line 4 of comments.ts).
        - Add error handling for the `db.comments.findByPost()` call (e.g., post not found).
        - Consider adding pagination for posts with many comments.
    tags:
      - multifile
      - pr-review
