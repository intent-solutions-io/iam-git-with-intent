name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: us-central1
  NODE_VERSION: '20'
  REGISTRY: us-central1-docker.pkg.dev

jobs:
  # =============================================================================
  # Quality Gates - Standard checks that always run
  # =============================================================================

  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Security & Architecture Checks
        run: |
          chmod +x scripts/ci/check_nodrift.sh
          bash scripts/ci/check_nodrift.sh

      - name: Agent Readiness Check
        run: |
          chmod +x scripts/ci/check_arv.sh
          bash scripts/ci/check_arv.sh

  # =============================================================================
  # Hard Mode - Optional internal ops checks (only on internal branch)
  # =============================================================================

  hard-mode-checks:
    name: Hard Mode (Internal)
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/internal' ||
      contains(github.event.head_commit.message, '[hard-mode]')
    steps:
      - uses: actions/checkout@v4

      - name: Hard Mode Drift Detection
        run: |
          chmod +x scripts/ci/check_nodrift.sh
          HARD_MODE=true bash scripts/ci/check_nodrift.sh

      - name: Hard Mode ARV
        run: |
          chmod +x scripts/ci/check_arv.sh
          HARD_MODE=true bash scripts/ci/check_arv.sh

  # =============================================================================
  # Build & Test
  # =============================================================================

  build:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: quality-checks

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint
        continue-on-error: false

      - name: Build
        run: npm run build

      - name: Type check
        run: npm run typecheck

      - name: Test
        run: npm run test

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: |
            packages/*/dist
            apps/*/dist

  # =============================================================================
  # Build Docker Images (push events only)
  # =============================================================================

  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'

    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WIF_PROVIDER }}
          service_account: ${{ vars.WIF_SERVICE_ACCOUNT }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Build and push API
        run: |
          docker build -f apps/api/Dockerfile \
            -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/api:${{ github.sha }} .
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/api:${{ github.sha }}
          docker tag ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/api:${{ github.sha }} \
                     ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/api:latest
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/api:latest

      - name: Build and push A2A Gateway
        run: |
          docker build -f apps/gateway/Dockerfile \
            -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/gateway:${{ github.sha }} .
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/gateway:${{ github.sha }}
          docker tag ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/gateway:${{ github.sha }} \
                     ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/gateway:latest
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/gateway:latest

      - name: Build and push GitHub Webhook
        run: |
          docker build -f apps/github-webhook/Dockerfile \
            -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/github-webhook:${{ github.sha }} .
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/github-webhook:${{ github.sha }}
          docker tag ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/github-webhook:${{ github.sha }} \
                     ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/github-webhook:latest
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/github-webhook:latest

      # Phase 35: Build and push Worker (needs full monorepo context)
      - name: Build and push Worker
        run: |
          docker build -f apps/worker/Dockerfile \
            -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/worker:${{ github.sha }} .
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/worker:${{ github.sha }}
          docker tag ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/worker:${{ github.sha }} \
                     ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/worker:latest
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/worker:latest

    outputs:
      api_image: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/api:${{ github.sha }}
      gateway_image: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/gateway:${{ github.sha }}
      webhook_image: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/github-webhook:${{ github.sha }}
      worker_image: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/worker:${{ github.sha }}

  # =============================================================================
  # Deploy to Dev (develop branch)
  # =============================================================================

  deploy-dev:
    name: Deploy Dev
    needs: build-images
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment: dev

    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WIF_PROVIDER }}
          service_account: ${{ vars.WIF_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '1.8.7'

      - name: OpenTofu Format Check
        working-directory: infra
        run: tofu fmt -check -recursive

      - name: OpenTofu Validate
        working-directory: infra
        run: |
          tofu init -backend=false
          tofu validate

      - name: Deploy Infrastructure
        working-directory: infra
        run: |
          tofu init
          tofu apply -auto-approve \
            -var="environment=dev" \
            -var="project_id=${{ env.PROJECT_ID }}" \
            -var="gwi_api_image=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/api:${{ github.sha }}" \
            -var="a2a_gateway_image=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/gateway:${{ github.sha }}" \
            -var="github_webhook_image=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/github-webhook:${{ github.sha }}" \
            -var="gwi_worker_image=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/worker:${{ github.sha }}"

      - name: Deploy Agents to Agent Engine
        run: |
          echo "Deploying agents to Vertex AI Agent Engine (dev)..."
          # Agents are deployed as Vertex AI Reasoning Engines

      - name: Verify Gateway Health
        run: |
          GATEWAY_URL=$(gcloud run services describe gwi-gateway --region=${{ env.REGION }} --format='value(status.url)' 2>/dev/null || echo "")
          if [ -n "$GATEWAY_URL" ]; then
            echo "Checking health at $GATEWAY_URL/health"
            curl -sf "$GATEWAY_URL/health" | jq .
          else
            echo "Gateway service not deployed yet"
          fi

  # =============================================================================
  # Deploy to Prod (main branch)
  # =============================================================================

  deploy-prod:
    name: Deploy Prod
    needs: build-images
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: prod

    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WIF_PROVIDER }}
          service_account: ${{ vars.WIF_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '1.8.7'

      - name: OpenTofu Format Check
        working-directory: infra
        run: tofu fmt -check -recursive

      - name: OpenTofu Validate
        working-directory: infra
        run: |
          tofu init -backend=false
          tofu validate

      - name: Deploy Infrastructure
        working-directory: infra
        run: |
          tofu init
          tofu apply -auto-approve \
            -var="environment=prod" \
            -var="project_id=${{ env.PROJECT_ID }}" \
            -var="gwi_api_image=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/api:${{ github.sha }}" \
            -var="a2a_gateway_image=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/gateway:${{ github.sha }}" \
            -var="github_webhook_image=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/github-webhook:${{ github.sha }}" \
            -var="gwi_worker_image=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/gwi/worker:${{ github.sha }}"

      - name: Deploy Agents to Agent Engine
        run: |
          echo "Deploying agents to Vertex AI Agent Engine (prod)..."

      - name: Verify Gateway Health
        run: |
          GATEWAY_URL=$(gcloud run services describe gwi-gateway --region=${{ env.REGION }} --format='value(status.url)' 2>/dev/null || echo "")
          if [ -n "$GATEWAY_URL" ]; then
            echo "Checking health at $GATEWAY_URL/health"
            curl -sf "$GATEWAY_URL/health" | jq .
          else
            echo "Gateway service not deployed yet"
          fi
