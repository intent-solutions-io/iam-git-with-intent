name: Drift Detection

on:
  schedule:
    # Run weekly on Sunday at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual trigger

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: us-central1

jobs:
  detect-drift:
    name: Detect Infrastructure Drift
    runs-on: ubuntu-latest
    environment: prod

    permissions:
      contents: read
      id-token: write
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WIF_PROVIDER }}
          service_account: ${{ vars.WIF_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '1.8.7'

      - name: Initialize OpenTofu
        working-directory: infra
        run: tofu init

      - name: Check for Drift
        id: drift
        working-directory: infra
        continue-on-error: true
        run: |
          # Run plan with detailed exit code
          # Exit code 0 = no changes
          # Exit code 2 = drift detected
          tofu plan -var-file="envs/prod.tfvars" -detailed-exitcode -out=tfplan 2>&1 | tee plan_output.txt
          echo "exitcode=$?" >> $GITHUB_OUTPUT

      - name: Parse Drift Summary
        if: steps.drift.outputs.exitcode == '2'
        id: summary
        working-directory: infra
        run: |
          # Extract summary line
          SUMMARY=$(grep -E "Plan:|No changes" plan_output.txt | head -1 || echo "Drift detected")
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT

          # Count changes
          ADDS=$(grep -oP '\d+(?= to add)' plan_output.txt || echo "0")
          CHANGES=$(grep -oP '\d+(?= to change)' plan_output.txt || echo "0")
          DESTROYS=$(grep -oP '\d+(?= to destroy)' plan_output.txt || echo "0")
          echo "adds=$ADDS" >> $GITHUB_OUTPUT
          echo "changes=$CHANGES" >> $GITHUB_OUTPUT
          echo "destroys=$DESTROYS" >> $GITHUB_OUTPUT

      - name: Create Drift Issue
        if: steps.drift.outputs.exitcode == '2'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Infrastructure Drift Detected - ${new Date().toISOString().split('T')[0]}`;
            const body = `## Infrastructure Drift Detected

            The weekly drift detection workflow found differences between the OpenTofu state and live GCP resources.

            ### Summary
            - **Adds**: ${{ steps.summary.outputs.adds || '?' }}
            - **Changes**: ${{ steps.summary.outputs.changes || '?' }}
            - **Destroys**: ${{ steps.summary.outputs.destroys || '?' }}

            ### Action Required
            1. Review the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            2. Identify the source of drift (manual changes, failed deploys, etc.)
            3. Either:
               - Apply OpenTofu to align infrastructure with code
               - Update code to match desired infrastructure state

            ### Policy
            - Drift must be resolved within 24 hours
            - All infrastructure changes must go through OpenTofu + CI
            - Manual console changes are not permitted

            ---
            *Automated by drift-detection workflow*`;

            // Check if there's already an open drift issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'drift,infrastructure'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['drift', 'infrastructure', 'p1']
              });
            } else {
              // Comment on existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## New Drift Detection Run\n\n${body}`
              });
            }

      - name: No Drift Detected
        if: steps.drift.outputs.exitcode == '0'
        run: |
          echo "No infrastructure drift detected. State matches live resources."

      - name: Drift Check Failed
        if: steps.drift.outputs.exitcode != '0' && steps.drift.outputs.exitcode != '2'
        run: |
          echo "Drift check failed with exit code: ${{ steps.drift.outputs.exitcode }}"
          cat infra/plan_output.txt
          exit 1
