name: Gemini Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  gemini-code-review:
    name: Gemini 2.5 Flash Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Collect Changed Files
        id: collect
        run: |
          # Get changed files (source code only)
          git diff origin/main...HEAD --name-only | \
            grep -E '\.(ts|tsx|js|jsx|py|go|rs|yaml|yml|json)$' | \
            grep -v -E '(package-lock|pnpm-lock|yarn\.lock|\.d\.ts$)' \
            > changed_files.txt || true

          CHANGED_COUNT=$(wc -l < changed_files.txt | tr -d ' ')
          echo "changed_count=$CHANGED_COUNT" >> $GITHUB_OUTPUT

          if [ "$CHANGED_COUNT" -eq 0 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "No reviewable files changed"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Reviewing $CHANGED_COUNT files"
          fi

      - name: Build Review Context
        if: steps.collect.outputs.skip != 'true'
        run: |
          echo "# PR Code Changes" > context.txt
          echo "" >> context.txt

          while read -r file; do
            if [ -f "$file" ]; then
              echo "### $file" >> context.txt
              echo '```' >> context.txt
              git diff origin/main...HEAD -- "$file" | head -200 >> context.txt
              echo '```' >> context.txt
              echo "" >> context.txt
            fi
          done < changed_files.txt

          # Truncate to 80KB for token limits
          head -c 80000 context.txt > context_truncated.txt
          mv context_truncated.txt context.txt
          echo "Context: $(wc -c < context.txt) bytes"

      - name: Run Gemini Review
        if: steps.collect.outputs.skip != 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          PROMPT="You are a senior code reviewer for Git With Intent, an AI-powered PR automation platform.

          Review this PR and provide actionable feedback. Focus on:
          1. Security - Secrets, injection, auth bypass
          2. Correctness - Logic errors, edge cases, types
          3. Architecture - Design patterns, separation of concerns
          4. Performance - Inefficiencies, N+1 queries

          Format response as:
          ## Summary
          [1-2 sentences]

          ## Critical Issues ðŸ”´
          [Must fix - security/correctness]

          ## Suggestions ðŸŸ¡
          [Should consider]

          ## Good Practices âœ…
          [What was done well]

          Be specific with file names and line numbers."

          CONTEXT=$(cat context.txt)

          # Build JSON request
          jq -n \
            --arg prompt "$PROMPT" \
            --arg context "$CONTEXT" \
            --arg pr "PR #$PR_NUMBER: $PR_TITLE" \
            '{
              contents: [{
                parts: [{
                  text: ($prompt + "\n\n" + $pr + "\n\n" + $context)
                }]
              }],
              generationConfig: {
                temperature: 0.1,
                maxOutputTokens: 4096
              }
            }' > request.json

          # Call Gemini API
          HTTP_CODE=$(curl -s -w "%{http_code}" -o response.json \
            -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @request.json)

          if [ "$HTTP_CODE" != "200" ]; then
            echo "API error: HTTP $HTTP_CODE"
            cat response.json
            echo "Review unavailable (API error)" > gemini_review.txt
          else
            jq -r '.candidates[0].content.parts[0].text // "No response"' response.json > gemini_review.txt
          fi

          cat gemini_review.txt

      - name: Post Review Comment
        if: steps.collect.outputs.skip != 'true'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('gemini_review.txt', 'utf8');
            const count = '${{ steps.collect.outputs.changed_count }}';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ¤– Gemini 2.5 Flash Code Review\n\n**Files Reviewed:** ${count}\n\n${review}\n\n---\n<sub>Powered by Gemini 2.5 Flash</sub>`
            });

      - name: Skip Notice
        if: steps.collect.outputs.skip == 'true'
        run: echo "No source files changed - skipping review"
