# SDK Type Code Generation

This document explains how the Git With Intent SDK automatically generates TypeScript types from the OpenAPI specification for the Gateway API.

## Overview

The SDK uses **[openapi-typescript](https://github.com/drwpow/openapi-typescript)** to automatically generate TypeScript types from the OpenAPI specification located at `apps/gateway/openapi.yaml`. This ensures that:

1. **Type Safety**: SDK types are always in sync with the actual API
2. **DX**: Developers get autocompletion and type checking for all API operations
3. **Maintainability**: No manual type maintenance required
4. **Documentation**: Types include JSDoc comments from the OpenAPI spec

## Architecture

```
apps/gateway/openapi.yaml
    │
    ├─> [scripts/generate-sdk-types.ts]
    │       │
    │       ├─> openapi-typescript (generator)
    │       │
    │       └─> packages/sdk/src/generated/
    │               ├── gateway-types.ts (auto-generated)
    │               └── index.ts (barrel export)
    │
    └─> packages/sdk/src/types.ts
            ├── Re-exports generated types
            ├── Type helper utilities
            └── Manual SDK-specific types
```

## Generated Files

### `packages/sdk/src/generated/gateway-types.ts`

This file is **auto-generated** and contains:

- `paths` - All API endpoints with request/response types
- `operations` - Operation-specific types (by operationId)
- `components` - Reusable schemas, parameters, responses

**⚠️ DO NOT EDIT THIS FILE MANUALLY** - It will be overwritten on the next generation.

### `packages/sdk/src/generated/index.ts`

Barrel file that re-exports all generated types for easier imports.

## Usage

### Generating Types

Types are automatically generated before each build via the `prebuild` hook in `packages/sdk/package.json`.

**Manual generation:**

```bash
# From repository root
npm run generate:sdk-types

# Or from packages/sdk
cd packages/sdk
npm run generate:types
```

**Verbose mode:**

```bash
npx tsx scripts/generate-sdk-types.ts --verbose
```

### Validating Types

Ensure generated types are in sync with the OpenAPI spec:

```bash
# From repository root
npm run validate:sdk-types

# Or from packages/sdk
cd packages/sdk
npm run validate:types
```

The validation script checks:
- Generated files exist
- Types are up-to-date with the OpenAPI spec
- Generated file structure is correct

## Using Generated Types

### Basic Usage

```typescript
import type { paths, components, operations } from '@gwi/sdk';

// Access path types
type SearchPath = paths['/v1/search'];

// Access component schemas
type ConnectorManifest = components['schemas']['ConnectorManifest'];

// Access operation types
type SearchOperation = operations['searchConnectors'];
```

### Type Helper Utilities

The SDK provides convenient type extraction utilities:

```typescript
import type {
  RequestBody,
  SuccessResponse,
  PathParams,
  QueryParams,
} from '@gwi/sdk';

// Extract request body type
type PublishRequest = RequestBody<'publishFull'>;

// Extract successful response type (200/201)
type SearchResponse = SuccessResponse<'searchConnectors'>;

// Extract path parameters
type ConnectorParams = PathParams<'getConnector'>; // { id: string }

// Extract query parameters
type SearchParams = QueryParams<'searchConnectors'>; // { q?: string, ... }
```

### Convenience Type Aliases

For common operations, use the pre-defined aliases:

```typescript
import type {
  SearchConnectorsParams,
  SearchConnectorsResponse,
  GetConnectorResponse,
  PublishConnectorRequest,
  PublishConnectorResponse,
  ScimUser,
  ScimGroup,
  SsoAuthResponse,
} from '@gwi/sdk';

// Use in your code
function searchConnectors(
  params: SearchConnectorsParams
): Promise<SearchConnectorsResponse> {
  // Implementation
}
```

### Real-World Example

```typescript
import { GWIClient } from '@gwi/sdk';
import type {
  SearchConnectorsParams,
  SearchConnectorsResponse,
  PublishConnectorRequest,
} from '@gwi/sdk';

const client = new GWIClient({
  baseUrl: 'https://gateway.gitwithintent.com',
});

// Fully typed search
const searchParams: SearchConnectorsParams = {
  q: 'github',
  capabilities: 'auth,cloud',
  page: 1,
  pageSize: 20,
};

const results: SearchConnectorsResponse = await client.search(searchParams);

// Fully typed publish
const publishRequest: PublishConnectorRequest = {
  manifest: {
    id: 'my-connector',
    version: '1.0.0',
    displayName: 'My Connector',
    author: 'Me',
    capabilities: ['auth'],
  },
  tarball: 'base64-encoded-tarball',
  signature: {
    version: 1,
    keyId: 'key-123',
    algorithm: 'ed25519',
    signature: 'signature-data',
    checksum: 'sha256-checksum',
    signedAt: new Date().toISOString(),
  },
};

await client.publish(publishRequest);
```

## Workflow

### When OpenAPI Spec Changes

1. **Update OpenAPI Spec**: Edit `apps/gateway/openapi.yaml`
2. **Regenerate Types**: Run `npm run generate:sdk-types`
3. **Validate**: Run `npm run validate:sdk-types`
4. **Test**: Run SDK tests to ensure compatibility
5. **Commit**: Commit both the spec and generated types together

### CI/CD Integration

The validation script is integrated into the ARV (Agent Readiness Verification) pipeline:

```bash
npm run arv  # Includes SDK type validation
```

CI will fail if:
- Generated types are missing
- Generated types are out of date with the OpenAPI spec
- Generated file structure is invalid

## Troubleshooting

### Types Are Out of Date

**Problem**: CI fails with "Generated types are outdated"

**Solution**:
```bash
npm run generate:sdk-types
git add packages/sdk/src/generated/
git commit -m "chore(sdk): regenerate types from OpenAPI spec"
```

### Generated Types Are Missing

**Problem**: `packages/sdk/src/generated/gateway-types.ts` not found

**Solution**:
```bash
npm run generate:sdk-types
```

### Type Errors After Spec Update

**Problem**: TypeScript errors after updating OpenAPI spec

**Solution**:
1. Regenerate types: `npm run generate:sdk-types`
2. Update SDK code to match new types
3. Update manual types in `types.ts` if needed

### Generation Fails

**Problem**: `npm run generate:sdk-types` fails

**Debugging**:
```bash
# Run with verbose output
npx tsx scripts/generate-sdk-types.ts --verbose

# Check OpenAPI spec is valid
npx @redocly/cli lint apps/gateway/openapi.yaml

# Verify dependencies are installed
npm install
```

### Import Errors

**Problem**: Can't import generated types

**Solution**:
1. Ensure types were generated: `npm run generate:sdk-types`
2. Build the SDK: `npm run build` (from packages/sdk)
3. Check import paths use `.js` extension (ESM requirement)

## Best Practices

### 1. Don't Edit Generated Files

Never manually edit `packages/sdk/src/generated/*` files. They will be overwritten.

### 2. Use Type Helpers

Prefer the type helper utilities over direct access to `operations`:

```typescript
// ✅ Good - Clear and maintainable
type SearchResponse = SuccessResponse<'searchConnectors'>;

// ❌ Avoid - Verbose and fragile
type SearchResponse = operations['searchConnectors']['responses'][200]['content']['application/json'];
```

### 3. Create Convenience Aliases

For frequently used types, create aliases in `types.ts`:

```typescript
// In packages/sdk/src/types.ts
export type MyCommonType = SuccessResponse<'myOperation'>;
```

### 4. Keep Spec and Types in Sync

Always regenerate types after updating the OpenAPI spec:

```bash
# After editing apps/gateway/openapi.yaml
npm run generate:sdk-types
npm run validate:sdk-types
npm run typecheck
```

### 5. Version Control Generated Files

**Always commit generated files** to version control. This ensures:
- CI doesn't need to regenerate types
- Type history is preserved
- Easier to review type changes in PRs

### 6. Document Breaking Changes

When OpenAPI changes cause breaking type changes:

1. Document in CHANGELOG
2. Update SDK version (semver)
3. Provide migration guide

## Advanced Usage

### Custom Type Transformations

To customize the generated types, edit `scripts/generate-sdk-types.ts`:

```typescript
const ast = await openapiTS(fileUrl, {
  transform: (schemaObject, metadata) => {
    // Add custom transformations here
    // For example, add custom JSDoc comments
    return undefined; // Return undefined for default behavior
  },
});
```

### Extending Generated Types

Create wrapper types for additional type safety:

```typescript
import type { components } from './generated/gateway-types.js';

// Create a branded type for IDs
export type ConnectorId = components['schemas']['ConnectorManifest']['id'] & {
  readonly __brand: 'ConnectorId';
};

// Runtime validation
export function toConnectorId(value: string): ConnectorId {
  if (!/^[a-z][a-z0-9-]*$/.test(value)) {
    throw new Error('Invalid connector ID format');
  }
  return value as ConnectorId;
}
```

## Related Documentation

- [OpenAPI Specification](../../apps/gateway/openapi.yaml)
- [SDK README](./README.md)
- [openapi-typescript Documentation](https://github.com/drwpow/openapi-typescript)
- [Git With Intent API Documentation](../../000-docs/)

## Maintenance

### Update Dependencies

Check for updates to `openapi-typescript`:

```bash
npm outdated openapi-typescript
npm update openapi-typescript
```

After updating, regenerate types and test:

```bash
npm run generate:sdk-types
npm run test
```

### Monitor Generation Performance

For large OpenAPI specs, generation may be slow. Profile with:

```bash
time npx tsx scripts/generate-sdk-types.ts --verbose
```

## Support

For issues with type generation:

1. Check this documentation
2. Review [openapi-typescript issues](https://github.com/drwpow/openapi-typescript/issues)
3. Consult project maintainers
4. File an issue with:
   - OpenAPI spec snippet
   - Expected vs actual output
   - Verbose generation logs
